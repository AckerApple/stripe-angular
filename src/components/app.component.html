<stripe-bank #stripeBank
  [(token)]="api.bank.result"
  (tokenChange)="sending=false;flatten(api.bank)"
  (catch)="sending=false;lastError=$event"
  (invalidChange)="sending=false;lastError=$event"
></stripe-bank>

<!-- ⚙️ ❌ 🔑 💠 ↙️ 🐠 🔐 💳 👀 🏦 -->
<table cellPadding="0" cellSpacing="0" border="0" style="width:100%;height:100%;">
  <tr>
    <td>
      <br />
      <div class="margin pad text-white text-center">
        <h1 style="margin:0;" (click)="downloadAllGroupsJson()">🐠 stripe-angular {{version}}</h1>
        <div class="text-center">
          <div>🎛 Dashboard for testing many common Stripe work flows.</div>
          <div class="text-xs opacity-80">
            <small>Display elements are managed by Stripe-Angular components.</small>
            <div class="text-xxs">
              👀 <a class="underline" (click)="showMore = !showMore">read more about this tool</a>
            </div>
          </div>
        </div>
        <div class="flex-center">
          <p *ngIf="showMore" class="text-xs opacity-70 max-width-900 text-justify">
            📕 This tool started as just functionality for Stripe elements for the Angular framework. It has since grown into a full featured testing app for not only just 🐠 stripe-angular but now also for Plaid, Stripe Webhooks, and so much more.
            <br />
            <br />
            For specific client side 🐠 stripe-angular documentation and support, <span class="underline"><a class="no-a-style" href="https://github.com/AckerApple/stripe-angular">use the README.md file</a></span>. Then come back here to interactively test time and time again to affirm understandings.
          </p>
        </div>
      </div>
      <ng-container *ngIf="!loaded">⏰ Loading Stripe...</ng-container>

      <ng-container *ngIf="loaded">
        <div class="flex-wrap flex-center">
          <!--- ⚙️ Settings -->
          <div class="tool-wrap" [ngClass]="settings.edit || !storage.key ? 'flex2' : 'flex1'" style="min-width:35vw">
            <h3 class="margin-0 text-left text-white">⚙️ Settings</h3>
            <div class="text-left flex-1 radius-5" style="background-color:#888;">
              <p class="pad text-xs opacity-80">Settings <b>required</b> to properly interact with Stripe and this tool</p>
              <settings #settings [storage]="storage" [(edit)]="editConfig" (saveChange)="save()"
                (publicKeyChange)="hideShowStripe()"
                (metadataUpdate)="defaultMetadata($event)"
              ></settings>
            </div>
          </div>

          <!-- hide elements when possibly changing keys -->
          <ng-container *ngIf="stripe && !editConfig">
            <ng-container *ngTemplateOutlet="cardTemplate"></ng-container>
            <ng-container *ngTemplateOutlet="bankTemplate"></ng-container>
            <tool-wrap class="flex1 flex-center" [api]="api.confirm_pay_intent" [(format)]="storage.format" showForm="1"></tool-wrap>
          </ng-container>
        </div>

        <ng-container *ngIf="sending">
          <div>
            Sending to Stripe...
          </div>
        </ng-container>

        <div *ngIf="lastError">
          <strong>🔴 Last recorded error</strong>
          <textarea wrap="off" class="bg-danger width-full"
            style="height:25vh;min-height:200px;"
          >{{lastError | json}}</textArea>
        </div>
      </ng-container>

      <div>
        <group-tools [scope]="groupsScope" [groups]="allGroups" [storage]="storage" selectedGroupClass="text-xs bg-grey-2x margin-1">
          <!--change default group displays-->
          <ng-template #groupTemplate let-defaultTemplate="defaultTemplate" let-group="group" let-selected="selected" let-current="current">
            <ng-container [ngSwitch]="group.title">

              <ng-container *ngSwitchCase="'🐠 Stripe Functionality'">
                <div class="flex1 text-white pad hover-bg-positive margin-xxs"
                [class.bg-grey-3x]="selected" [class.bg-grey]="!selected"
                >
                  <h2 class="opacity-half margin-0 pad-0">🔗 Server Functionality</h2>
                  <small *ngIf="!current" class="opacity-70">Helpful tools ONLY available in this demo by Stripe <strong>privateKey</strong></small>
                </div>
              </ng-container>

              <ng-container *ngSwitchCase="'🪝 Webhook Functionality'">
                <ng-container *ngTemplateOutlet="webhookGroupTemplate;context:{selected:selected, current:current}"></ng-container>
              </ng-container>

              <ng-container *ngSwitchCase="'🏦 Plaid Functionality'">
                <ng-container *ngTemplateOutlet="plaidGroupTemplate;context:{selected:selected, current:current}"></ng-container>
              </ng-container>

              <ng-container *ngSwitchDefault>
                <ng-container *ngTemplateOutlet="defaultTemplate"></ng-container>
              </ng-container>
            </ng-container>
          </ng-template>

          <ng-template #groupBody let-selected="selected" let-group="group" let-defaultTemplate="defaultTemplate">
            <ng-container [ngSwitch]="group?.title">
              <ng-container *ngSwitchCase="'🐠 Stripe Functionality'">
                <div *ngIf="!selected && !storage.key" class=" width-full bg-warning pad text-dark margin">
                  ⚠️ To continue, you must enter a <b>privateKey</b> in the ⚙️ Settings form
                </div>
                <ng-container *ngTemplateOutlet="defaultTemplate"></ng-container>
              </ng-container>

              <ng-container *ngSwitchCase="'🪝 Webhook Functionality'">
                <div *ngIf="!selected && !storage.plaid.client_id" class="width-full bg-warning pad text-dark margin">
                  ⚠️ To continue, you must enter a <b>webhookSigningSecret</b> in the ⚙️ Settings form
                </div>
                <div *ngIf="!selected" class="text-white width-full">
                  <ng-container *ngTemplateOutlet="webhookKeyForm"></ng-container>
                </div>
                <ng-container *ngTemplateOutlet="defaultTemplate"></ng-container>
              </ng-container>

              <ng-container *ngSwitchCase="'🏦 Plaid Functionality'">
                <div *ngIf="!selected" class="pad text-white width-full">
                  <ng-container *ngTemplateOutlet="plaidKeyForm"></ng-container>
                </div>

                <ng-container *ngIf="storage.plaid.client_id">
                  <!-- only UI works if no local server -->
                  <div *ngIf="!localServerActive" class="pad">
                    <tool-wrap class="flex1 flex-stacked" [api]="api.plaid_createPublicToken" [(format)]="storage.format"></tool-wrap>
                    <ng-container *ngTemplateOutlet="warnNoLocalServer"></ng-container>
                  </div>

                  <!-- display everything when server available -->
                  <ng-container *ngIf="localServerActive">
                    <ng-container *ngTemplateOutlet="defaultTemplate"></ng-container>
                  </ng-container>
                </ng-container>

                <div *ngIf="!storage.plaid.client_id" class=" width-full bg-warning pad text-dark margin">
                  ⚠️ To continue, you must enter a client_id above
                </div>
              </ng-container>

              <ng-container *ngSwitchDefault>
                <ng-container *ngTemplateOutlet="defaultTemplate"></ng-container>
              </ng-container>
            </ng-container>
          </ng-template>
        </group-tools>
      </div>

      <br /><br />

      <div class="tool-wrap" style="align-items: center;">
        <h2 style="margin:0;text-align:left;color:white;"
          (mousedown)="startValueTimer('apiEditorMode', true)"
          (mouseup)="stopValueTimer('apiEditorMode')"
        >📕 Best of Resources</h2>
        
        <div *ngIf="localServerActive && apiEditorMode">
          <button (click)="saveApisJson()"
          >save api json</button>
        </div>

        <div style="border-radius:5px;background-color:#888;text-align:left;padding:1em;">
          <div class="text-center flex-center flex-wrap">
              <a *ngFor="let item of links" [href]="item.url"
                target="_blank" class="resource-link no-a-style hover-bg-positive active-bg-balanced"
              >{{item.title}}</a>
            </div>
          </div>
      </div>
      <br />
    </td>
  </tr>
</table>

<ng-template #cardTemplate>
  <div class="tool-wrap flex1">
    <label for="card-like-element" class="color-white">
      <h3 style="flex-grow:1;margin:0;text-align:left;">💳 Card Element</h3>
    </label>

    <div class="tool-panel">
      <p class="text-xs text-xs opacity-80">Test &lt;stripe-card&gt; component by entering card details below</p> 
      <div id="card-like-element" style="background-color:white;border-radius: 5px;border:1px solid #DDD;padding:.33em;">
        <stripe-card
          #stripeCard
          (changed) = "api.card.changedEvent = $event"
          [options] = "options"
          [(complete)]="cardComplete"
          (catch)="api.card.error=$event;sending=false;lastError=$event"
          (invalidChange)="sending=false;lastError=$event"
          (cardMounted) = "setCardElements($event)"

          [(token)]="api.card.result.token"
          (tokenChange)="sending=false;flatten(api.card)"

          [(source)]="api.card.result.source"
          (sourceChange)="flatten(api.card)"

          [(paymentMethod)]="api.card.result.payment_method"
          (paymentMethodChange)="flatten(api.card)"
        ></stripe-card>
      </div>

      <!--<div *ngIf="!cardComplete;" class="opacity-half text-center pad-v">
        ...awaiting card entry above...
      </div>-->

      <div *ngIf="api.card.error" class="margin-xs pad-xs bg-assertive text-sm">
        {{ api.card.error.message ? api.card.error.message : (api.card.error | json) }}
      </div>

      <div class="text-center opacity-70">
        <small
          [class.text-assertive]="!cardComplete"
          [class.text-balanced]="cardComplete"
        ><strong>card entry status</strong>: {{ cardComplete ? 'complete' : 'incomplete' }}</small>
      </div>

      <div class="pad-top">
        <div class="flex-wrap child-margin-1">
          <button type="button" class="flex-1  hover-bg-positive active-bg-balanced" [disabled]="!cardComplete"
            (click)="lastError=null;sending=true;stripeCard.createPaymentMethod(storage.requests.paymentMethod)"
          >💳 create pay method</button>

          <button type="button" class="flex-1  hover-bg-positive active-bg-balanced" [disabled]="!cardComplete"
            (click)="lastError=null;sending=true;stripeCard.createSource(storage.requests.source)"
            title="This is the one method that causes a webhook to fire. You can then upgrade to a payment method by associating that source with a customer."
          >💳 create source</button>

          <button type="button" class="flex-1  hover-bg-positive active-bg-balanced" [disabled]="!cardComplete"
            (click)="lastError=null;sending=true;stripeCard.createToken(extraData)"
            title="Typically used for creating Stripe Connected Account external_accounts"
          >🪙 create token</button>
        </div>

        <div *ngIf="api.card.result.token">
          <br />
          <strong>↘️ Token Response</strong>
          <dump [value]="api.card.result.token" showLevels="1"></dump>
        </div>
      
        <div *ngIf="api.card.result.source">
          <br />
          <div style="display:flex">
            <strong style="flex-grow:1">↘️ Source Response</strong>
          </div>
          <dump [value]="api.card.result.source" showLevels="1"></dump>
        </div>
      
        <div *ngIf="api.card.result.payment_method">
          <br />
          <div class="flex">
            <strong>↘️ Payment Method Response</strong>
          </div>
          <dump [value]="api.card.result.payment_method" showLevels="1"></dump>
        </div>
      
        <div class="text-xs pad-v">
          <h4 class="margin-bottom-xs">📋 copy/paste test card numbers</h4>
          <div class="flex-wrap child-margin-1 text-center text-xs">
            <ng-container *ngFor="let item of testNums">
              <a (click)="copyText(item.number)" class="flex-1 hover-bg-positive active-bg-balanced radius-10 bg-dark"
                [title]="item.description"
              >
                <div [class.pad-h-2x]="item.icon">
                  <span *ngIf="item.icon" class="pos-rel">
                    <span class="pos-abs" style="right:3px;bottom:-.7em">{{item.icon}}</span>
                  </span>
                  <span>{{item.number}}</span>
                </div>
                <div class="text-sm opacity-half line-height-90">{{item.hint}}</div>
              </a>
            </ng-container>
          </div>
        </div>

        <br />

        <!--<h4>Additional functionality</h4>-->
        <div class="flex-wrap">
          <button type="button" class="flex-1 hover-bg-positive active-bg-balanced"
            (click)="editOptions=!editOptions"
            [style.background-color] = "editOptions && '#0099CC' || null"
          >🔧 options</button>
          <ng-container *ngTemplateOutlet="optionalCardControls"></ng-container>
        </div>

        <div *ngIf="editExtraData">
          <br />
          <div class="flex-apart">
            <strong title="Card specific way of providing token related info (includes metadata)"
            >🪙 token data</strong>
            <small>
              <a href="https://stripe.com/docs/api/tokens" target="_blank">token data</a>
            </small>
          </div>
          <textarea spellcheck="false" wrap="off" style="width:100%;height:25vh;min-height:200px;"
            (change)="changeExtraData($event.target.value)"
          >{{ extraData | json }}</textArea>
        </div>

        <div *ngIf="editPaymentMethodRequest">
          <br />
          <div class="flex-apart">
            <div>💳 payment method data</div>
            <small>
              <a href="https://stripe.com/docs/payments/payment-methods/overview" target="_blank">overview</a>&nbsp;
              <a href="https://stripe.com/docs/js/payment_methods/create_payment_method" target="_blank">docs</a>
            </small>
          </div>
          <textarea spellcheck="false" wrap="off" style="width:100%;height:25vh;min-height:200px;"
            (change)="changePaymentMethodRequest($event.target.value)"
          >{{ storage.requests.paymentMethod | json }}</textArea>
          <div style="opacity: 0.5;font-size:0.7em;padding:1em 0;">creating a payment method alone does not fire any webhooks. Use Source instead</div>
        </div>

        <div *ngIf="editSourceRequest">
          <br />
          <div style="display:flex;justify-content:space-between">
            <strong [style.color]="storage.temp.invalidSourceData && 'red'">source data</strong>
            <small>
              <a href="https://stripe.com/docs/js/tokens_sources/create_source" target="_blank">docs</a>
            </small>
          </div>
          <textarea wrap="off" spellcheck="false"
            style="width:100%;height:25vh;min-height:200px;"
            (change)="changeSourceRequest($event.target.value)"
          >{{ storage.requests.source | json }}</textArea>
        </div>

        <div *ngIf="editOptions">
          <br />
          <div style="display:flex;justify-content:space-between">
            <strong>options</strong>
            <small>
              <a href="https://stripe.com/docs/js/elements_object/create_element?type=card" target="_blank">docs</a>
            </small>
          </div>
          <textarea spellcheck="false"
            wrap="off" style="width:100%;height:25vh;min-height:200px;"
            (change)="changeOptions($event.target.value)"
          >{{ options | json }}</textArea>
        </div>

      </div>

      <div *ngIf="api.card.changedEvent" class="text-smx">
        <br />
        <strong style="opacity: 50%;">⚡️ Change Event Info</strong>
        <dump [value]="api.card.changedEvent" showLevels="0"></dump>
        <!--<textarea
          wrap="off" style="width:100%;height:25vh;min-height:200px;" disabled
        >{{ api.card.changedEvent | json }}</textArea>-->
      </div>

      <div class="text-xs opacity-80 text-center child-pad-xs">
        <span class="underline">
          <a href="https://stripe.com/docs/testing#cards" target="_blank" class="text-xs no-a-style">demo card nums</a>
        </span>

        <span class="underline">
          <a href="https://stripe.dev/elements-examples/" target="_blank" class="text-xs no-a-style">Stripe Elements examples</a>
        </span>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #optionalCardControls>
  <button type="button" class="hover-bg-positive active-bg-balanced flex-1"
    (click)="editSourceRequest=!editSourceRequest"
    [style.background-color] = "editSourceRequest && '#0099CC' || null"
  >💳 source data</button>

  <button type="button" class="hover-bg-positive active-bg-balanced flex-1"
    (click)="editPaymentMethodRequest=!editPaymentMethodRequest"
    [style.background-color] = "editPaymentMethodRequest && '#0099CC' || null"
  >💳 payment method data</button>

  <button type="button" class="hover-bg-positive active-bg-balanced flex-1"
    (click)="editExtraData=!editExtraData"
    [style.background-color] = "editExtraData && '#0099CC' || null"
  >🪙 token data</button>
</ng-template>

<ng-template #warnNoLocalServer>
  <div>
    <div class="bg-warning pad">
      <div class="text-dark">
        <div class="flex-wrap">
          <span class="flex-1">
            ⚠️ No 🐠 stripe-angular local server detected.
          </span>
          <a (click)="checkLocalServer()">🔄</a>
        </div>
        <br /><br />
        <div>
          <small class="opacity-70">Additional functionality available, run the following commands in a local terminal:</small>
        </div>
      </div>
<pre class="bg-dark pad-xs margin-0 text-white">
git clone --branch gh-pages https://github.com/ackerapple/stripe-angular
cd stripe-angular
npm install --production
npm run start
</pre>
    </div>
    <div class="text-right">
      <button (click)="localServerActive = true" class="hover-bg-positive active-bg-balanced">
        🔧 show tools anyways
      </button>
    </div>
  </div>
</ng-template>

<ng-template #bankTemplate>
  <tool-wrap class="flex1" [id]="'serverToolsWrap' + api.bank.title" [name]="'serverToolsWrap' + api.bank.title"
    [api]="api.bank" [(format)]="storage.format" [allowHide]="false" [dumpLevels]="0"
  >
    <ng-template #footer>
      <tool-relations [api]="api.bank"
        [(showApi)] = "groupsScope.showApi" (showApiChange)="groupsScope.showGroup = getGroupByApi($event, groupsScope.showGroup)"
      ></tool-relations>
    </ng-template>
  </tool-wrap>

</ng-template>

<ng-template #webhookGroupTemplate let-selected="selected" let-current="current">
  <div class="flex1 text-white pad hover-bg-positive margin-xxs"
    [class.bg-grey-3x]="selected" [class.bg-grey]="!selected"
  >
    <h2 class="opacity-half margin-0 pad-0">🪝 Webhook Functionality</h2>
    <small *ngIf="!current" class="opacity-70">Helpful tools ONLY available in this demo by using entered <strong>webhookSigningSecret</strong></small>
  </div>
</ng-template>

<ng-template #plaidGroupTemplate let-selected="selected" let-current="current">
  <div class="flex1 text-white pad hover-bg-positive margin-xxs"
    [class.bg-grey-3x]="selected" [class.bg-grey]="!selected"
  >
    <h2 class="opacity-half margin-0 pad-0">🏦 Plaid Functionality</h2>
    <small *ngIf="!current" class="opacity-70">Helpful tools ONLY available in this demo by using entered <strong>plaidConfig</strong></small>
  </div>
</ng-template>

<ng-template #plaidKeyForm>
  <div class="pad flex-center flex-wrap" *ngIf="localServerActive">
    <br />
    <form class="flex-1" (submit)="save()" action="javascript:">
      <div class="flex-1 flex-wrap flex-center flex-valign-center child-margin-xxs">
        <div class="flex-1 max-width-800">
          <div class="flex">
            <strong class="flex-1">🆔 CLIENT_ID</strong>

            <a href="https://dashboard.plaid.com/team/keys"
              target="_blank" class="text-xxs text-white no-a-style"
            >🔑🔗</a>
            <key-changer [keys]="storage.plaid.clientIds" [(value)]="storage.plaid.client_id"
              (valueChange) = "save()"
            ></key-changer>
          </div>
          <div>
            <input type="password" class="width-full"
              (keyup)="storage.plaid.client_id=$event.target.value;"
              [value]="storage.plaid.client_id || null"
              placeholder="Plaid > Team > Keys > client_id"
            />
          </div>
          <a *ngIf="storage.plaid.client_id?.length > 12" class="hover-bg-positive active-bg-balanced text-xs opacity-third pad-xxs pos-abs"
            (click)="copyText(storage.plaid.client_id)"
          >
            {{ storage.plaid.client_id }}
          </a>
        </div>

        <div class="flex-1 max-width-800">
          <div class="flex-apart">
            <strong>👂 SECRET</strong>
            <key-changer [keys]="storage.plaid.secrets" [(value)]="storage.plaid.secret"
              (valueChange) = "save()"
            ></key-changer>
          </div>
          <div>
            <input type="password" class="width-full"
              (keyup)="storage.plaid.secret=$event.target.value;"
              [value]="storage.plaid.secret || null"
              placeholder="Plaid > Team > Keys > Sandbox"
            />
          </div>
          <a *ngIf="storage.plaid.secret?.length > 12" class="hover-bg-positive active-bg-balanced text-xs opacity-third pad-xxs pos-abs"
            (click)="copyText(storage.plaid.secret)"
          >
            {{ storage.plaid.secret | slice : 0 : 6 }}{{ 'x'.repeat((storage.plaid.secret | slice : 8 : storage.plaid.secret.length).length) }}
          </a>
        </div>

        <div>
          <div class="invisible">🔐</div>
          <button type="submit" class="text-dark hover-bg-positive bg-balanced active-bg-balanced">
            💾&nbsp;save
          </button>
        </div>
      </div>
      <div class="flex-center child-margin-xxs">
        <div class="pos-rel text-xxs opacity-70 width-30vw">
          <div class="pos-abs flex-center width-full text-center margin-top-3x">
            <ng-container *ngTemplateOutlet="localStorageCheck"></ng-container>
          </div>
        </div>
      </div>
    </form>
  </div>
</ng-template>

<ng-template #webhookKeyForm>
  <div class="flex-center">
    <form (submit)="save()" action="javascript:">
      <div class="flex-wrap child-margin-xxs child-pad-xxs">
        <!--webhook secrets-->
        <webhook-secret-edit (save)="save()" class="flex1 bg-grey"></webhook-secret-edit>
        <!--webhook servers-->
        <webhook-server-edit (save)="save()" class="flex1 bg-grey"></webhook-server-edit>
      </div>
    </form>
  </div>
</ng-template>
