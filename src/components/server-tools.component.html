
<div class="flex-wrap flex-center">

  <tool-wrap class="flex-1" [api]="stripeUrlApis.create_customer"
    [pasteFavs] = "[
      ['source '+stripeUrlApis.create_source.result?.type, stripeUrlApis.create_source.result?.id, 'source'],
      ['method '+card.payment_method?.card.brand+' '+card.payment_method?.card.last4, card.payment_method?.id, $setCustomerDefaultPayMethod],
      [api.bank.token?.bank_account.bank_name+' '+api.bank.token?.bank_account.last4, api.bank.token?.id,'source'],
      ['source '+card.source?.card.brand+' '+card.source?.card.last4, card.source?.id, 'source'],
      ['plaid bank token', plaidServerApis.plaid_stripeBankCreate.result?.stripe_bank_account_token, 'source']
    ]"
  >
    <ng-template #footer>
      <ng-container *ngIf="card.payment_method && stripeUrlApis.create_customer.result">
        <ng-container *ngTemplateOutlet="customerPayMethodAttach;context:{payMethod:card.payment_method, customer:stripeUrlApis.create_customer.result}"></ng-container>
      </ng-container>
    </ng-template>
  </tool-wrap>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.customer_attach_method"
    [pasteFavs] = "[
      ['method '+card.payment_method?.card.brand+' '+card.payment_method?.card.last4, card.payment_method?.id, 'id']
    ]"
  >
  </tool-wrap>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.customer_attach_source"
    [pasteFavs] = "[
      ['source '+stripeUrlApis.create_source.result?.type, stripeUrlApis.create_source.result?.id, 'source'],
      [api.bank.token?.bank_account.bank_name+' '+api.bank.token?.bank_account.last4, api.bank.token?.id,'source'],
      ['source '+card.source?.card.brand+' '+card.source?.card.last4, card.source?.id, 'source'],
      ['plaid bank token', plaidServerApis.plaid_stripeBankCreate.result?.stripe_bank_account_token, 'source'],
      ['customer '+stripeUrlApis.create_customer.result?.description, stripeUrlApis.create_customer.result?.id, 'id']
    ]"
  >
  </tool-wrap>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.customer_get"
    [pasteFavs] = "[
      ['customer ' + stripeUrlApis.create_customer.result?.id, stripeUrlApis.create_customer.result?.id, 'id'],
      ['pay method customer ' + stripeUrlApis.payment_method_get.result?.customer, stripeUrlApis.payment_method_get.result?.customer, 'id']
    ]"
  ></tool-wrap>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.customer_get_sources"
    [pasteFavs] = "[
      ['customer ' + stripeUrlApis.create_customer.result?.id, stripeUrlApis.create_customer.result?.id, 'id']
    ]"
  ></tool-wrap>

  <div class="tool-wrap">
    <div style="display:flex;flex-wrap:wrap;align-items: baseline;">
      <h3 style="margin:0;padding:0;flex-grow:1;color:white">
        <label>
          👤 UPDATE Customer
        </label>
      </h3>
      <small>
        <a
        href="https://stripe.com/docs/api/customers/update"
        style="color:white;" target="_blank"
        >api docs</a>
      </small>
    </div>
    <div class="tool-panel">
      <small style="display:flex;flex-wrap:wrap;color:white;">
        <a
          *ngIf="stripeUrlApis.create_customer.result"
          (click)="customer_update.data = cleanCustomerUpdateData(stripeUrlApis.create_customer.result)"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.customer_update.data.id === stripeUrlApis.create_customer.result.id && '.3'"
        >
          use customer {{stripeUrlApis.create_customer.result.id}}
        </a>

        <a
          *ngIf="card.source"
          (click)="api.customer_update.data.source = card.source.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.customer_update.data.source === card.source.id && '.3'"
          [title] = "card.source.id"
        >
          use source {{card.source.card.brand}} {{card.source.card.last4}}
        </a>

        <a
          *ngIf="card.payment_method"
          (click)="setCustomerDefaultPayMethod(api.customer_update.data)"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.customer_update.data.payment_method === card.payment_method.id && '.3'"
        >
          default method {{card.payment_method.card.brand}} {{card.payment_method.card.last4}}
        </a>

      </small>
      <simple-route-edit [config]="api.customer_update"></simple-route-edit>

      <ng-container *ngIf="card.payment_method && api.customer_update.data.id">
        <ng-container *ngTemplateOutlet="customerPayMethodAttach;context:{payMethod:card.payment_method, customer:api.customer_update.data}"></ng-container>
      </ng-container>
    </div>
  </div>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.get_paymethods"
    [pasteFavs] = "[
      ['customer ' + stripeUrlApis.create_customer.result?.id, stripeUrlApis.create_customer.result?.id, 'customer']
    ]"
  ></tool-wrap>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.payment_method_get"
    [pasteFavs]="[
      ['pm '+card.payment_method?.card?.brand+' '+card.payment_method?.card?.last4, card.payment_method?.id, 'id']
    ]"
  >
    <ng-template #footer>
      <ng-container *ngIf="stripeUrlApis.payment_method_get.result">
        <button
          type="button"
          (click)="createCustomerByPaymentMethod(stripeUrlApis.payment_method_get.result)"
          [style.opacity]="stripeUrlApis.payment_method_get.result.customer ? '.3' : null"
        >👤 create customer by payment method</button>
      </ng-container>
    </ng-template>
  </tool-wrap>

  <div class="tool-wrap">
    <div style="display:flex;flex-wrap:wrap;align-items: baseline;">
      <h3 style="margin:0;padding:0;flex-grow:1;color:white">
        <label>💳 UPDATE Payment Method</label>
      </h3>
      <small>
        <a
        href="https://stripe.com/docs/payments/checkout/subscriptions/update-payment-details"
        style="color:white;" target="_blank"
        >checkout docs</a>&nbsp;
        <a
        href="https://stripe.com/docs/api/payment_methods/update"
        style="color:white;" target="_blank"
        >api docs</a>
      </small>
    </div>
    <div class="tool-panel">
      <small style="display:flex;flex-wrap:wrap;color:white;">
        <a
          *ngIf="stripeUrlApis.payment_method_get.result"
          (click)="api.payment_method_update.data = cleanPaymentMethodUpdateData(stripeUrlApis.payment_method_get.result)"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payment_method_update.data.id === stripeUrlApis.payment_method_get.result.id && '.3'"
          [title] = "stripeUrlApis.payment_method_get.result.id"
        >
          use pay method type {{stripeUrlApis.payment_method_get.result.type}}
        </a>
      </small>
      <simple-route-edit [config]="api.payment_method_update"></simple-route-edit>
    </div>
  </div>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.source_get"
    [pasteFavs] = "[
      ['use source '+card.source?.card.brand+' '+card.source?.card.last4, card.source?.id, 'id'],
      ['source '+stripeUrlApis.create_source.result?.type, stripeUrlApis.create_source.result?.id, 'id'],
    ]"
  >
    <ng-template #prependFormFooter>
      <div *ngIf="stripeUrlApis.source_get.data.id?.slice(0,3) === 'ba_'" class="bg-warning text-dark pad margin-v">
        ⚠️ It appears you are using a bank source which is NOT truly a source. Fetch bank sources using GET /customers/:id/sources
      </div>
      <div *ngIf="stripeUrlApis.source_get.data.id?.slice(0,5) === 'btok_'" class="bg-warning text-dark pad margin-v">
        ⚠️ It appears you are using a bank token which is NOT a source
      </div>
      <ng-container *ngIf="stripeUrlApis.source_get.result">
        <button
          type="button"
          (click)="createCustomerByToken(stripeUrlApis.source_get.result)"
          [style.opacity] = "stripeUrlApis.create_customer.data.source === stripeUrlApis.source_get.result.id && '.3'"
        >👤 create customer by source</button>
      </ng-container>
    </ng-template>
  </tool-wrap>

  <div class="tool-wrap">
    <div style="display:flex;flex-wrap:wrap;align-items: baseline;">
      <h3 style="margin:0;padding:0;flex-grow:1;color:white">
        <label>💳 UPDATE Source</label>
      </h3>
      <small>
        <a
        href="https://stripe.com/docs/api/sources/update"
        style="color:white;" target="_blank"
        >api docs</a>
      </small>
    </div>
    <div class="tool-panel">
      <small style="display:flex;flex-wrap:wrap;color:white;">
        <a
          *ngIf="stripeUrlApis.source_get.result"
          (click)="api.source_update.data = cleanSourceUpdateData(stripeUrlApis.source_get.result)"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.source_update.data.id === stripeUrlApis.source_get.result.id && '.3'"
          [title] = "stripeUrlApis.source_get.result.id"
        >
          use source type {{stripeUrlApis.source_get.result.type}}
        </a>
      </small>
      <simple-route-edit [config]="api.source_update"></simple-route-edit>
    </div>
  </div>

  <div class="tool-wrap">
    <div style="display:flex;flex-wrap:wrap;align-items: baseline;">
      <h3 style="margin:0;padding:0;flex-grow:1;color:white">
        <label for="card-like-element">💸 Create Pay Intent</label>
      </h3>
      <small>
        <a href="https://stripe.com/docs/api/payment_intents" style="color:white;" target="_blank"
        >api docs</a>
      </small>
    </div>
    <div class="tool-panel">
      <small style="display:flex;flex-wrap:wrap;color:white;">
        <a *ngIf="stripeUrlApis.create_customer.result"
          (click)="api.payintent.data.customer = stripeUrlApis.create_customer.result.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.customer === stripeUrlApis.create_customer.result.id && '.3'"
        >
          use customer {{stripeUrlApis.create_customer.result.description}}
        </a>
        <a *ngIf="stripeUrlApis.customer_get.data.id"
          (click)="api.payintent.data.customer = stripeUrlApis.customer_get.data.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.customer === stripeUrlApis.customer_get.data.id && '.3'"
        >
          use GET customer {{stripeUrlApis.customer_get.data.id}}
        </a>
        <a *ngIf="card.payment_method"
          (click)="api.payintent.data.payment_method = card.payment_method.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.payment_method === card.payment_method.id && '.3'"
          [title] = "card.payment_method.id"
        >
          use method {{card.payment_method.card.brand}} {{card.payment_method.card.last4}}
        </a>
        <a *ngIf="card.source"
          (click)="api.payintent.data.payment_method = card.source.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.payment_method === card.source.id && '.3'"
          [title] = "card.source.id"
        >
          use source {{card.source.card.brand}} {{card.source.card.last4}}
        </a>
        <a *ngIf="card.token"
          (click)="api.payintent.data.payment_method = card.token.card.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.payment_method === card.token.card.id && '.3'"
          [title] = "card.token.id"
        >
          use token {{card.token.card.brand}} {{card.token.card.last4}}
        </a>
        <a *ngIf="stripeUrlApis.payment_method_get.result"
          (click)="api.payintent.data.payment_method = stripeUrlApis.payment_method_get.result.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.payment_method === stripeUrlApis.payment_method_get.result.id && '.3'"
          [title] = "stripeUrlApis.payment_method_get.id"
        >
          use method {{stripeUrlApis.payment_method_get.result.brand}} {{stripeUrlApis.payment_method_get.result.last4}}
        </a>
        <a *ngIf="stripeUrlApis.payment_method_get.result?.customer"
          (click)="api.payintent.data.customer = stripeUrlApis.payment_method_get.result.customer"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [style.opacity] = "api.payintent.data.customer === stripeUrlApis.payment_method_get.result.customer && '.3'"
          [title] = "stripeUrlApis.payment_method_get.result.customer"
        >
          use pay method customer
        </a>
      </small>

      <simple-route-edit [config]="api.payintent"></simple-route-edit>

      <!--
        <ng-container *ngIf="api.payintent.result">
          <button type="button" (click)="fetchPayIntentUpdate(api.payintent)">retrieve update</button>
        </ng-container>
      -->

      <ng-container *ngIf="api.payintent.result?.next_action?.use_stripe_sdk?.stripe_js">
        <div>
          <ng-container *ngTemplateOutlet="nextActionLink;context:{link:api.payintent.result.next_action.use_stripe_sdk.stripe_js}"></ng-container>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="tool-wrap">
    <div style="display:flex;flex-wrap:wrap;align-items: baseline;">
      <h3 style="margin:0;padding:0;flex-grow:1;color:white">
        <label for="card-like-element">💸 Retrieve Pay Intent</label>
      </h3>
      <small>
        <a href="https://stripe.com/docs/api/payment_intents/retrieve" style="color:white;" target="_blank"
        >api docs</a>
      </small>
    </div>
    <div class="tool-panel">
      <simple-route-edit [config]="api.payintent_retrieve"></simple-route-edit>
    </div>
  </div>

  <div class="tool-wrap">
    <div style="display:flex;flex-wrap:wrap;align-items: baseline;">
      <h3 style="margin:0;padding:0;flex-grow:1;color:white">
        <label for="card-like-element">
          🚫 💸 Cancel Pay Intent
        </label>
      </h3>
      <small>
        <a href="https://stripe.com/docs/api/payment_intents/cancel" style="color:white;" target="_blank"
        >api docs</a>
      </small>
    </div>
    <div class="tool-panel">
      <simple-route-edit [config]="api.payintent_cancel"></simple-route-edit>
    </div>
  </div>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.charge"
    [pasteFavs] = "[
      ['source '+stripeUrlApis.create_source.result?.type, stripeUrlApis.create_source.result?.id, 'source'],
      ['👤 🏦 use attached '+ (stripeUrlApis.customer_attach_source.result?.bank_name || stripeUrlApis.customer_attach_source.result?.type), stripeUrlApis.customer_attach_source.result?.id, 'source'],
      ['💳 method '+card.payment_method?.card.brand+' '+card.payment_method?.card.last4, card.payment_method?.id, 'payment_method'],
      ['🪙 token '+card.token?.card.brand+' '+card.token?.card.last4, card.token?.card.id, 'source'],
      ['💳 source '+card.source?.card.brand+' '+card.source?.card.last4, card.source?.id, 'source'],
      ['👤 customer '+stripeUrlApis.create_customer.result?.description, stripeUrlApis.create_customer.result?.id, 'customer'],
      ['👤 💳 source '+(stripeUrlApis.create_customer.result?.sources?.length && stripeUrlApis.create_customer.result.sources[0].object), (stripeUrlApis.create_customer.result?.sources?.length && stripeUrlApis.create_customer.result.sources[0].id), 'source']
    ]"
  >
    <!-- This api only takes customer-to-source associations as "source" (cant just be source.id)
      ['plaid '+plaidServerApis.plaid_stripeBankCreate.result?.stripe_bank_account_token, plaidServerApis.plaid_stripeBankCreate.result?.stripe_bank_account_token, 'source']
      ['bank '+ api.bank.token?.bank_account.bank_name+' '+api.bank.token?.bank_account.last4, api.bank.token?.id, 'source'],
    -->
    <ng-template #requestHeaderItems>
      <ng-container *ngFor="let item of stripeUrlApis.create_customer.result && stripeUrlApis.create_customer.result?.sources?.data">
        <a *ngIf="item.object === 'bank_account'"
          (click)="stripeUrlApis.charge.data.source = item.id"
          style="text-decoration:underline;cursor:pointer;margin:1em;"
          [title] = "item.id"
          [style.opacity] = "stripeUrlApis.charge.data.source === item.id && '.3'"
        >
          use customer bank {{item.bank_name}} {{item.last4}}
        </a>
      </ng-container>
    </ng-template>
    <ng-template #footer>
      <div style="text-align:center;opacity:.5;">
        <small>
          <a href="https://stripe.com/docs/payments/payment-intents/migration/charges" target="_blank"
          >prefer pay intents</a>
        </small>
      </div>
    </ng-template>
  </tool-wrap>

  <tool-wrap class="flex-1" [api]="stripeUrlApis.create_source"></tool-wrap>


</div>


<ng-template #customerPayMethodAttach let-customer="customer" let-payMethod="payMethod">
  <button *ngIf="customer.invoice_settings?.default_payment_method != payMethod.id"
    (click)="attachCustomerPayMethod(customer.id, payMethod)"
  >
    attach method {{payMethod.card.brand}} {{payMethod.card.last4}}
  </button>

  <button (click)="detachCustomerPayMethod(payMethod)">
    detach method {{payMethod.card.brand}} {{payMethod.card.last4}}
  </button>

  <ng-container *ngIf="stripeUrlApis.customer_attach_method.result">
    <div *ngTemplateOutlet="simpleRouteResults;context:{resultAt: stripeUrlApis.customer_attach_method.resultAt, result: stripeUrlApis.customer_attach_method.result, title: 'Attach Result'}"></div>
  </ng-container>

  <ng-container *ngIf="api.customer_detach_method.result">
    <div *ngTemplateOutlet="simpleRouteResults;context:{resultAt: api.customer_detach_method.resultAt, result: api.customer_detach_method.result, title: 'Detach Result'}"></div>
  </ng-container>
</ng-template>
