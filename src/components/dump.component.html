<!-- IF 1: undefined ELSE goto simpleTemplate -->
<ng-container *ngIf="[null, undefined].includes(value);else simpleTemplate">
  <ng-container *ngTemplateOutlet="dumpSimple;context:{key:key, value:typing}"></ng-container>
</ng-container>

<!-- IF 2: simple value ELSE goto objectTemplate -->
<ng-template #simpleTemplate>
  <ng-container *ngIf="['boolean','number','string'].includes(typing); else objectTemplate">
    <ng-container *ngTemplateOutlet="dumpSimple;context:{key:key, value:value}"></ng-container>
  </ng-container>
</ng-template>

<ng-template #objectTemplate>
  <!-- IF 3: object value -->
  <ng-container [ngSwitch]="value">
    <!--null-->
    <ng-container *ngSwitchCase="null">
      <ng-container *ngIf="showKids">
        <ng-container *ngTemplateOutlet="dumpSimple;context:{key: key, value:'null'}"></ng-container>
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchDefault>
      <div *ngIf="isRootDump" style="width: 100%;line-height: 90%;">
        <div class="pos-rel">
          <div class="pos-abs text-xxxs child-margin-1 flex" style="top:-18px;right:-6px">
            <a *ngIf="!format || format==='small'" class="flex-valign-center radius-5 text-white pad-h-xxs hover-bg-balanced"
              [ngClass] = "showAll ? 'bg-balanced' : 'bg-dark'"
              (click)="showAll = !showAll"
              title="hide/show all sub objects"
            >üëÅ</a>
            <a class="flex-valign-center radius-5 text-white pad-h-xxs hover-bg-balanced"
              (click)="formatChange.emit(format='small')"
              [class]="!format || format==='small' ? 'bg-positive' : 'bg-dark'"
            >small</a>
            <a class="flex-valign-center radius-5 text-white pad-h-xxs hover-bg-balanced"
              (click)="formatChange.emit(format='json')"
              [class]="format==='json' ? 'bg-positive' : 'bg-dark'"
            >json</a>
            <a class="flex-valign-center radius-5 text-white pad-h-xxs hover-bg-balanced active-bg-energized"
              (click)="copyAsJsonText(value)"
              [class]="format==='json' ? 'bg-positive' : 'bg-dark'"
            >copy</a>
          </div>
        </div>
        <textarea *ngIf="format==='json'" disabled wrap="off" style="width:100%;height:25vh;min-height:400px"
        >{{ value | json }}</textArea>
      </div>
      
      <ng-container *ngIf="!format || format==='small'">
        <!-- array -->
        <ng-container *ngIf="value.push && value.pop;else dumpObject">
          <div class="border border-radius-5 bg-danger flex-stacked text-dark">
            <a class="text-white text-xxs border-white pad-xxs bg-assertive flex-1 flex-apart"
              [class.border-bottom] = "show"
              (click)="show = !show"
            >
              <strong>{{key}}</strong>
              <sup class="opacity-80 text-xs pad-left-xs">[{{value.length}}]</sup>
            </a>
            <div *ngIf="showAll || show || showKids || (show==undefined && showLevels > 0)" class="flex-wrap child-margin-xxs">
              <ng-container *ngFor="let item of value">
                <!-- recurse -->
                <dump [value]="item" [showLevels]="showLevels" [showKids]="showAll || showKids" [isRootDump]="false"></dump>
              </ng-container>
            </div>
          </div>
        </ng-container>

        <!-- object -->
        <ng-template #dumpObject>
          <div class="flex1">
            <div class="border border-radius-5 bg-info flex-stacked text-sm text-dark">
              <a *ngIf="key" class="text-white text-xxs border-white pad-xxs bg-positive flex-1 flex-apart"
                [class.border-bottom] = "show"
                (click)="show = !show"
              >
                <strong>{{key}}</strong>
                <sup class="opacity-80 text-xs pad-left-xs">
                  <span ng-non-bindable>&#123;</span>{{ (value | keys).length }}<span ng-non-bindable>}</span>
                </sup>
              </a>
              <div *ngIf="!key || showKids || show || (show==undefined && showLevels > 0)" class="flex-wrap">
                <ng-container *ngFor="let item of value | keyvalue : unsorted">
                  <!-- recurse -->
                  <dump [value]="item.value" [key]="item.key" [showLevels]="showLevels - 1" [showKids]="showAll || showKids"
                    class="flex-wrap child-margin-xxs pad-xxs"
                    [class.flex1] = "!item.value || typeof(item.value) !== 'object'"
                    [isRootDump]="false"
                  ></dump>
                </ng-container>
              </div>
            </div>
          </div>
        </ng-template>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<ng-template #dumpSimple let-key="key" let-value="value">
  <div class="flex1 text-xs text-dark">
    <div *ngIf="key" class="strong text-xxs border-white border-bottom" style="line-height: 95%;"
    >{{key}}</div>
    <ng-container *ngIf="value.search && (value.slice(0,8)==='https://' || value.slice(0,7)==='http://');else simpleValue">
      <a (click)="copyText(value)" [href]="value" target="_blank" class="hover-bg-warning active-bg-energized"
        title = "tap to copy"
      >{{value}}</a>
    </ng-container>
    <ng-template #simpleValue>
      <div (click)="copyText(value)" class="cursor-pointer hover-bg-warning active-bg-energized"
        [class.text-balanced]="value === true"
        [class.text-assertive]="value === false"
        [title] = "value.constructor?.name === 'Number' && value > 1000000000 ? value > 946702800000 ? 'Milliseconds > Unix epoch:\n' + (value | date : 'long') : 'Seconds > Unix epoch:\n' + (value*1000 | date : 'long') : ''"
      >{{value}}</div>
    </ng-template>
  </div>
</ng-template>